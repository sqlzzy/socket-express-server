<!DOCTYPE html>
  <head>
    <title>Main page</title>
  </head>
  <body>
    <h1>Main page</h1>
    <form id="room-form">
      <label for="name-player">Your name:</label>
      <input type="text" id="name-player" size="10" maxlength="10" required>
      <br>
      <br>
      <button id="create-room-btn">Create room</button>
      <span id="text-enter">or enter</span>
      <label for="id-room">ID room</label>
      <input type="text" id="id-room" size="42" maxlength="36" required>
      <button style="display:none;" id="copy-id-room-btn">Copy ID room</button>
      <br>
      <br>
      <button id="start-btn" type="submit">Go!</button>
    </form>
    <br>
    <br>
    
    <div id="player-list"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const inputNamePlayer = document.querySelector('#name-player');
        const btnCreateRoom = document.querySelector('#create-room-btn');
        const inputIdRoom = document.querySelector('#id-room');
        const btnCopyIdRoom = document.querySelector('#copy-id-room-btn');
        const btnStart = document.querySelector('#start-btn');
        const textEnter = document.querySelector('#text-enter');
        const currentLocation = location.origin;
        const form = document.querySelector('#room-form');

        btnCreateRoom.addEventListener('click', () => {
            event.preventDefault();
            socket.emit('createRoom');
        });

        socket.on('roomCreated', (idRoom) => {
            btnCreateRoom.style.display = "none";
            textEnter.style.display = "none";
            btnCopyIdRoom.style.display = "block";
            inputIdRoom.value = idRoom;
        });

        btnCopyIdRoom.addEventListener('click', () => {
            event.preventDefault();
            navigator.clipboard.writeText(inputIdRoom.value);
        });

        btnStart.addEventListener('click', () => {
            event.preventDefault();
            const idRoom = inputIdRoom.value;

            socket.emit('checkExistRoom', idRoom);
        });

        function createError(text) {
          const spanError = document.createElement('span');
          spanError.textContent = text;
          spanError.style.color = 'red';
          spanError.style.marginLeft = '12px';
          spanError.setAttribute('id', 'error-message');

          return spanError;
        }

        socket.on('roomExist', (isExist) => {
            const namePlayer = inputNamePlayer.value
            const idRoom = inputIdRoom.value;
            const idPlayer = socket.id;
            const errorMessage = document.getElementById('error-message');

            if (errorMessage) {
              errorMessage.textContent = '';
            }

            if (isExist) {
              const spanError = createError('A room with that id already exists');
              btnStart.insertAdjacentElement('afterend', spanError);
            } else {
              if (idRoom && namePlayer) {
                const dataPlayer = {namePlayer, idPlayer, idRoom};

                socket.emit('joinRoom', dataPlayer);

                document.location.href = `${currentLocation}/player/?room=${idRoom}&player=${idPlayer}`;
              } else if (!idRoom && !namePlayer) {
                const spanError = createError('Player name and room id not entered');
                btnStart.insertAdjacentElement('afterend', spanError);
              } else if (!idRoom) {
                const spanError = createError('Room id not entered');
                btnStart.insertAdjacentElement('afterend', spanError);
              } else if (!namePlayer) {
                const spanError = createError('Player name not entered');
                btnStart.insertAdjacentElement('afterend', spanError);
              }
            }
        });
    </script>
  </body>
</html>
